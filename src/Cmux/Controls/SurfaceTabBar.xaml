<UserControl x:Class="Cmux.Controls.SurfaceTabBar"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:Cmux.ViewModels"
             Height="38" Background="{StaticResource SurfaceTabBackgroundBrush}">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <!-- Tab list -->
        <ItemsControl Grid.Column="0" ItemsSource="{Binding Surfaces}">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <StackPanel Orientation="Horizontal" Margin="4,0,0,0" />
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
                <DataTemplate DataType="{x:Type vm:SurfaceViewModel}">
                    <Border x:Name="tabBorder" Padding="14,6" Cursor="Hand"
                            Margin="2,4,2,4" CornerRadius="6"
                            MouseLeftButtonDown="Tab_Click">
                        <Border.Background>
                            <SolidColorBrush x:Name="tabBg" Color="Transparent" />
                        </Border.Background>
                        <Border.ContextMenu>
                            <ContextMenu Tag="{Binding}">
                                <MenuItem Header="Rename" Click="RenameTab_Click" />
                                <MenuItem Header="Duplicate" Click="DuplicateTab_Click" />
                                <Separator />
                                <MenuItem Header="Split Right" InputGestureText="Ctrl+D" Click="SplitRight_Click" />
                                <MenuItem Header="Split Down" InputGestureText="Ctrl+Shift+D" Click="SplitDown_Click" />
                                <Separator />
                                <MenuItem Header="Close" InputGestureText="Ctrl+W" Click="CloseThisTab_Click" />
                                <MenuItem Header="Close Others" Click="CloseOtherTabs_Click" />
                            </ContextMenu>
                        </Border.ContextMenu>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="{Binding Name}" FontSize="12"
                                       Foreground="{StaticResource ForegroundDimBrush}"
                                       VerticalAlignment="Center"
                                       x:Name="tabText" />
                            <Button Grid.Column="1" Content="&#xE10A;" FontFamily="Segoe MDL2 Assets"
                                    FontSize="8" Margin="8,0,0,0" Padding="2"
                                    Opacity="0" x:Name="closeBtn"
                                    Style="{StaticResource CmuxButton}"
                                    Click="CloseTab_Click" Tag="{Binding}" />

                            <!-- Active tab bottom accent line -->
                            <Rectangle x:Name="activeIndicator" Grid.ColumnSpan="2"
                                       Height="2" VerticalAlignment="Bottom" Margin="0,0,0,-4"
                                       RadiusX="1" RadiusY="1" Opacity="0">
                                <Rectangle.Fill>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                        <GradientStop Color="#FF6366F1" Offset="0" />
                                        <GradientStop Color="#FF818CF8" Offset="0.5" />
                                        <GradientStop Color="#FFA78BFA" Offset="1" />
                                    </LinearGradientBrush>
                                </Rectangle.Fill>
                            </Rectangle>
                        </Grid>
                    </Border>
                    <DataTemplate.Triggers>
                        <!-- Selected tab styling -->
                        <DataTrigger Value="True">
                            <DataTrigger.Binding>
                                <MultiBinding Converter="{StaticResource EqualityConverter}">
                                    <Binding />
                                    <Binding RelativeSource="{RelativeSource AncestorType=UserControl}"
                                             Path="DataContext.SelectedSurface" />
                                </MultiBinding>
                            </DataTrigger.Binding>
                            <Setter TargetName="tabBorder" Property="Background"
                                    Value="{StaticResource SurfaceTabSelectedBrush}" />
                            <Setter TargetName="tabText" Property="Foreground"
                                    Value="{StaticResource ForegroundBrush}" />
                            <Setter TargetName="tabText" Property="FontWeight" Value="SemiBold" />
                            <Setter TargetName="activeIndicator" Property="Opacity" Value="1" />
                        </DataTrigger>
                        <!-- Hover effect -->
                        <Trigger SourceName="tabBorder" Property="IsMouseOver" Value="True">
                            <Setter TargetName="closeBtn" Property="Opacity" Value="0.7" />
                        </Trigger>
                        <!-- Hover animation (non-selected tabs) -->
                        <MultiDataTrigger>
                            <MultiDataTrigger.Conditions>
                                <Condition Binding="{Binding IsMouseOver, ElementName=tabBorder}" Value="True" />
                            </MultiDataTrigger.Conditions>
                            <MultiDataTrigger.EnterActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <ColorAnimation Storyboard.TargetName="tabBg"
                                                        Storyboard.TargetProperty="Color"
                                                        To="#FF1A1A2E" Duration="0:0:0.15" />
                                    </Storyboard>
                                </BeginStoryboard>
                            </MultiDataTrigger.EnterActions>
                            <MultiDataTrigger.ExitActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <ColorAnimation Storyboard.TargetName="tabBg"
                                                        Storyboard.TargetProperty="Color"
                                                        To="Transparent" Duration="0:0:0.15" />
                                    </Storyboard>
                                </BeginStoryboard>
                            </MultiDataTrigger.ExitActions>
                        </MultiDataTrigger>
                    </DataTemplate.Triggers>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>

        <!-- Inline search bar -->
        <Border Grid.Column="1" CornerRadius="6" Margin="4"
                Background="{StaticResource SurfaceHighBrush}" VerticalAlignment="Center"
                Height="26" Width="220">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="&#xE721;" FontFamily="Segoe MDL2 Assets"
                           FontSize="11" Foreground="{StaticResource ForegroundDimBrush}"
                           VerticalAlignment="Center" Margin="6,0,4,0" />
                <TextBox x:Name="SearchInput" Grid.Column="1"
                         Background="Transparent" Foreground="{StaticResource ForegroundBrush}"
                         CaretBrush="{StaticResource AccentBrush}"
                         BorderThickness="0" FontSize="12" Padding="2,2"
                         VerticalContentAlignment="Center"
                         TextChanged="SearchInput_TextChanged"
                         KeyDown="SearchInput_KeyDown" />
                <TextBlock x:Name="MatchCount" Grid.Column="2" Text=""
                           Foreground="{StaticResource ForegroundDimBrush}" FontSize="10"
                           VerticalAlignment="Center" Margin="4,0" />
                <StackPanel Grid.Column="3" Orientation="Horizontal" Margin="0,0,2,0">
                    <Button Content="&#xE010;" FontFamily="Segoe MDL2 Assets"
                            FontSize="9" Style="{StaticResource IconButton}"
                            Width="20" Height="20" Click="PrevMatch_Click" ToolTip="Previous (Shift+Enter)" />
                    <Button Content="&#xE011;" FontFamily="Segoe MDL2 Assets"
                            FontSize="9" Style="{StaticResource IconButton}"
                            Width="20" Height="20" Click="NextMatch_Click" ToolTip="Next (Enter)" />
                </StackPanel>
            </Grid>
        </Border>

        <!-- Add surface button -->
        <Button Grid.Column="2" Content="&#xE710;" FontFamily="Segoe MDL2 Assets" FontSize="12"
                Style="{StaticResource CmuxButton}"
                Click="AddTab_Click"
                Padding="8,0" Margin="2,2,4,2" Opacity="0.6" />

        <!-- Inline rename overlay -->
        <TextBox x:Name="TabRenameBox" Visibility="Collapsed"
                 FontSize="12" Background="{StaticResource SidebarItemHoverBrush}"
                 Foreground="{StaticResource ForegroundBrush}"
                 BorderBrush="{StaticResource AccentBrush}" BorderThickness="1" Padding="4,2"
                 VerticalAlignment="Center" HorizontalAlignment="Left"
                 MinWidth="80" MaxWidth="200"
                 LostFocus="TabRenameBox_LostFocus" KeyDown="TabRenameBox_KeyDown" />
    </Grid>
</UserControl>
