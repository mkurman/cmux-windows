<UserControl x:Class="Cmux.Controls.SurfaceTabBar"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:Cmux.ViewModels"
             Height="34" Background="{StaticResource SurfaceTabBackgroundBrush}">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <!-- Tab list -->
        <ItemsControl Grid.Column="0" ItemsSource="{Binding Surfaces}">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <StackPanel Orientation="Horizontal" />
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
                <DataTemplate DataType="{x:Type vm:SurfaceViewModel}">
                    <Border x:Name="tabBorder" Padding="14,6" Cursor="Hand"
                            Margin="1,4,1,0" Background="Transparent"
                            MouseLeftButtonDown="Tab_Click">
                        <Border.ContextMenu>
                            <ContextMenu Tag="{Binding}" Background="#FF141420" BorderBrush="#FF2A2A3C" BorderThickness="1" Padding="4">
                                <ContextMenu.Resources>
                                    <Style TargetType="MenuItem">
                                        <Setter Property="Foreground" Value="#FFE2E2E9" />
                                        <Setter Property="Background" Value="Transparent" />
                                        <Setter Property="Padding" Value="8,5" />
                                        <Setter Property="FontSize" Value="12" />
                                    </Style>
                                    <Style TargetType="Separator">
                                        <Setter Property="Background" Value="#FF2A2A3C" />
                                        <Setter Property="Margin" Value="4,2" />
                                    </Style>
                                </ContextMenu.Resources>
                                <MenuItem Header="Rename" Click="RenameTab_Click" />
                                <MenuItem Header="Duplicate" Click="DuplicateTab_Click" />
                                <Separator />
                                <MenuItem Header="Split Right" InputGestureText="Ctrl+D" Click="SplitRight_Click" />
                                <MenuItem Header="Split Down" InputGestureText="Ctrl+Shift+D" Click="SplitDown_Click" />
                                <Separator />
                                <MenuItem Header="Close" InputGestureText="Ctrl+W" Click="CloseThisTab_Click" />
                                <MenuItem Header="Close Others" Click="CloseOtherTabs_Click" />
                            </ContextMenu>
                        </Border.ContextMenu>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="{Binding Name}" FontSize="12"
                                       Foreground="{StaticResource ForegroundDimBrush}"
                                       x:Name="tabText" />
                            <Button Grid.Column="1" Content="&#xE10A;" FontFamily="Segoe MDL2 Assets"
                                    FontSize="8" Margin="8,0,0,0" Padding="2"
                                    Opacity="0" x:Name="closeBtn"
                                    Style="{StaticResource CmuxButton}"
                                    Click="CloseTab_Click" Tag="{Binding}" />

                            <!-- Active tab bottom accent line -->
                            <Rectangle x:Name="activeIndicator" Grid.ColumnSpan="2"
                                       Height="2" VerticalAlignment="Bottom" Margin="0,0,0,-6"
                                       RadiusX="1" RadiusY="1" Opacity="0">
                                <Rectangle.Fill>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                        <GradientStop Color="#FF6366F1" Offset="0" />
                                        <GradientStop Color="#FF818CF8" Offset="0.5" />
                                        <GradientStop Color="#FFA78BFA" Offset="1" />
                                    </LinearGradientBrush>
                                </Rectangle.Fill>
                            </Rectangle>
                        </Grid>
                    </Border>
                    <DataTemplate.Triggers>
                        <!-- Selected tab styling -->
                        <DataTrigger Value="True">
                            <DataTrigger.Binding>
                                <MultiBinding Converter="{StaticResource EqualityConverter}">
                                    <Binding />
                                    <Binding RelativeSource="{RelativeSource AncestorType=UserControl}"
                                             Path="DataContext.SelectedSurface" />
                                </MultiBinding>
                            </DataTrigger.Binding>
                            <Setter TargetName="tabBorder" Property="Background"
                                    Value="{StaticResource SurfaceTabSelectedBrush}" />
                            <Setter TargetName="tabText" Property="Foreground"
                                    Value="{StaticResource ForegroundBrush}" />
                            <Setter TargetName="tabText" Property="FontWeight" Value="SemiBold" />
                            <Setter TargetName="activeIndicator" Property="Opacity" Value="1" />
                        </DataTrigger>
                        <!-- Show close button on hover -->
                        <Trigger SourceName="tabBorder" Property="IsMouseOver" Value="True">
                            <Setter TargetName="closeBtn" Property="Opacity" Value="0.7" />
                        </Trigger>
                    </DataTemplate.Triggers>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>

        <!-- Add surface button -->
        <Button Grid.Column="1" Content="&#xE710;" FontFamily="Segoe MDL2 Assets" FontSize="12"
                Style="{StaticResource CmuxButton}"
                Click="AddTab_Click"
                Padding="8,0" Margin="2,2,4,2" Opacity="0.6" />

        <!-- Inline rename overlay -->
        <TextBox x:Name="TabRenameBox" Visibility="Collapsed"
                 FontSize="12" Background="#FF1A1A2E" Foreground="{StaticResource ForegroundBrush}"
                 BorderBrush="{StaticResource AccentBrush}" BorderThickness="1" Padding="4,2"
                 VerticalAlignment="Center" HorizontalAlignment="Left"
                 MinWidth="80" MaxWidth="200"
                 LostFocus="TabRenameBox_LostFocus" KeyDown="TabRenameBox_KeyDown" />
    </Grid>
</UserControl>
